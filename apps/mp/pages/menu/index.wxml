<view class="menu-container">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <view class="store-info">
      <text class="store-name">é‡åº†åº—-å°–å­tusk</text>
      <text class="status">è¥ä¸šä¸­ 08:00-02:00</text>
    </view>
  </view>

  <!-- åˆ†ç±»å’Œèœå• -->
  <view class="content">
    <!-- å·¦ä¾§åˆ†ç±» -->
    <scroll-view class="category-list" scroll-y>
      <view
        wx:for="{{categories}}"
        wx:key="id"
        class="category-item {{currentCategory === item.id ? 'active' : ''}}"
        bindtap="selectCategory"
        data-id="{{item.id}}"
      >
        <text>{{item.name}}</text>
      </view>
    </scroll-view>

    <!-- å³ä¾§èœå“ -->
    <scroll-view class="menu-list" scroll-y scroll-into-view="{{scrollIntoView}}">
      <view wx:for="{{menuItems}}" wx:key="id" class="menu-section" id="cat-{{item.categoryId}}">
        <view class="section-title">{{item.categoryName}}</view>
        <view class="items">
          <view wx:for="{{item.items}}" wx:key="id" wx:for-item="dish" class="menu-item">
            <view class="item-info">
              <view class="item-header">
                <text class="item-name">{{dish.name}}</text>
                <view wx:if="{{dish.status === 'SOLD_OUT'}}" class="sold-out-tag">å·²å”®ç½„</view>
              </view>
              <text class="item-desc">{{dish.description || ''}}</text>
              <view class="item-footer">
                <text class="price">Â¥ {{dish.price}}</text>
                <view class="stock-info" wx:if="{{dish.stock < 10 && dish.stock > 0}}">
                  <text>ä»…å‰©{{dish.stock}}ä»½</text>
                </view>
              </view>
            </view>
            <view class="item-action">
              <view wx:if="{{dish.status !== 'SOLD_OUT'}}" class="counter">
                <view
                  wx:if="{{cart[dish.id] > 0}}"
                  class="btn-minus"
                  bindtap="decreaseItem"
                  data-id="{{dish.id}}"
                >-</view>
                <text wx:if="{{cart[dish.id] > 0}}" class="count">{{cart[dish.id]}}</text>
                <view
                  class="btn-plus"
                  bindtap="increaseItem"
                  data-id="{{dish.id}}"
                  data-price="{{dish.price}}"
                  data-name="{{dish.name}}"
                >+</view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- è´­ç‰©è½¦æ  -->
  <view class="cart-bar" bindtap="showCart" wx:if="{{totalCount > 0}}">
    <view class="cart-info">
      <view class="cart-icon-wrapper">
        <view class="cart-badge">{{totalCount}}</view>
        <text class="cart-icon">ğŸ›’</text>
      </view>
      <view class="cart-price">
        <text class="total">Â¥{{totalPrice}}</text>
        <text class="delivery-tip">å·²é€‰{{totalCount}}ä»¶</text>
      </view>
    </view>
    <view class="checkout-btn" bindtap="checkout" catchtap="checkout">
      å»ç»“ç®—
    </view>
  </view>

  <!-- è´­ç‰©è½¦å¼¹çª— -->
  <view class="cart-modal {{showCartModal ? 'show' : ''}}" catchtap="hideCart">
    <view class="cart-content" catchtap="stopPropagation">
      <view class="cart-header">
        <text>å·²é€‰å•†å“</text>
        <text class="clear-btn" bindtap="clearCart">æ¸…ç©º</text>
      </view>
      <scroll-view class="cart-items" scroll-y>
        <view wx:for="{{cartItems}}" wx:key="id" class="cart-item">
          <view class="item-left">
            <text class="item-name">{{item.name}}</text>
            <text class="item-price">Â¥{{item.price}}</text>
          </view>
          <view class="item-right">
            <view class="counter">
              <view class="btn-minus" bindtap="decreaseItem" data-id="{{item.id}}">-</view>
              <text class="count">{{item.count}}</text>
              <view class="btn-plus" bindtap="increaseItem" data-id="{{item.id}}" data-price="{{item.price}}" data-name="{{item.name}}">+</view>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- ä¼˜æƒ åˆ¸é€‰æ‹©åŒºåŸŸ -->
      <view class="coupon-section" wx:if="{{isLoggedIn}}">
        <view class="coupon-header">
          <text>ä¼˜æƒ åˆ¸</text>
          <view class="coupon-action" bindtap="showCouponModal" wx:if="{{!selectedCoupon && availableCoupons.length > 0}}">
            <text class="select-coupon-text">é€‰æ‹©ä¼˜æƒ åˆ¸</text>
            <text class="arrow">></text>
          </view>
          <view class="coupon-action" bindtap="showCouponModal" wx:elif="{{!selectedCoupon}}">
            <text class="no-coupon-text">æš‚æ— å¯ç”¨ä¼˜æƒ åˆ¸</text>
          </view>
        </view>

        <!-- å·²é€‰æ‹©çš„ä¼˜æƒ åˆ¸ -->
        <view class="selected-coupon" wx:if="{{selectedCoupon}}">
          <view class="coupon-info">
            <text class="coupon-name">{{selectedCoupon.coupon.name}}</text>
            <text class="coupon-desc">
              {{selectedCoupon.coupon.type === 'AMOUNT' ? 'å‡' + selectedCoupon.coupon.value + 'å…ƒ' : ''}}
              {{selectedCoupon.coupon.type === 'DISCOUNT' ? selectedCoupon.coupon.value + 'æŠ˜' : ''}}
              {{selectedCoupon.coupon.type === 'PERCENTAGE' ? selectedCoupon.coupon.value + '%æŠ˜æ‰£' : ''}}
            </text>
          </view>
          <view class="coupon-remove" bindtap="unselectCoupon">å–æ¶ˆ</view>
        </view>
      </view>

      <!-- ä»·æ ¼æ±‡æ€» -->
      <view class="price-summary">
        <view class="price-row">
          <text class="label">å•†å“æ€»è®¡</text>
          <text class="value">Â¥{{originalPrice}}</text>
        </view>
        <view class="price-row" wx:if="{{selectedCoupon && discountAmount > 0}}">
          <text class="label">ä¼˜æƒ åˆ¸æŠ˜æ‰£</text>
          <text class="discount">-Â¥{{discountAmount}}</text>
        </view>
        <view class="price-row final-price">
          <text class="label">å®ä»˜é‡‘é¢</text>
          <text class="value">Â¥{{totalPrice}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸é€‰æ‹©å¼¹çª— -->
  <view class="coupon-modal {{showCouponModal ? 'show' : ''}}" catchtap="hideCouponModal">
    <view class="coupon-modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text>é€‰æ‹©ä¼˜æƒ åˆ¸</text>
        <view class="close-btn" bindtap="hideCouponModal">Ã—</view>
      </view>
      <scroll-view class="coupon-list" scroll-y>
        <view wx:for="{{availableCoupons}}" wx:key="id" class="coupon-option" bindtap="selectCoupon" data-id="{{item.id}}">
          <view class="coupon-left">
            <view class="coupon-amount">
              <text class="amount">{{item.coupon.value}}</text>
              <text class="unit">
                {{item.coupon.type === 'AMOUNT' ? 'å…ƒ' : ''}}
                {{item.coupon.type === 'DISCOUNT' ? 'æŠ˜' : ''}}
                {{item.coupon.type === 'PERCENTAGE' ? '%' : ''}}
              </text>
            </view>
          </view>
          <view class="coupon-right">
            <text class="coupon-name">{{item.coupon.name}}</text>
            <text class="coupon-condition" wx:if="{{item.coupon.minAmount > 0}}">æ»¡{{item.coupon.minAmount}}å…ƒå¯ç”¨</text>
            <text class="coupon-condition" wx:else>æ— é—¨æ§›</text>
            <text class="coupon-validity">{{item.validityText || 'æœ‰æ•ˆæœŸè‡³ï¼š' + item.endTime}}</text>
          </view>
        </view>
        <view class="no-coupons" wx:if="{{availableCoupons.length === 0}}">
          <text>æš‚æ— å¯ç”¨ä¼˜æƒ åˆ¸</text>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
